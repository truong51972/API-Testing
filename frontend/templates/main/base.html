<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>{% block title %}APIT{% endblock %}</title>
    {% load static %}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/pickr/pickr-themes.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/fonts/iconify-icons.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/css/core.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/demo.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/apex-charts/apex-charts.css' %}" />
    <link rel="stylesheet"href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    {% block extra_css %}{% endblock %}
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/message.css' %}">
    <link rel="stylesheet" href="{% static 'css/register.css' %}">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <style>

    </style>
</head>

<body>
    <div class="d-flex">
        {% include "main/sidebar.html" %}

        <main class="flex-grow-1 p-4">
            <!-- Global Loading Overlay -->
            <div id="global-loading-overlay" style="display:none;">
                <div class="global-loading-backdrop"></div>
                <div class="global-loading-spinner">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 small text-muted">Đang tải dữ liệu...</div>
                </div>
            </div>
            <!-- Notification Container -->
            {% if messages %}
            <div id="notification-container" class="notification-container"></div>
            {% endif %}

            {% block content %}{% endblock %}
        </main>
    </div>

    <script>
        // Global Loading Overlay Controller
        (function(){
            const overlay = document.getElementById('global-loading-overlay');
            let counter = 0;
            function show() {
                counter++;
                if (overlay && counter > 0) overlay.style.display = 'block';
            }
            function hide() {
                counter = Math.max(0, counter - 1);
                if (overlay && counter === 0) overlay.style.display = 'none';
            }
            window.__loadingOverlay = { show, hide };
        })();

        // Fetch Wrapper with timeout, basic retry, and global loading toggle
        (function(){
            const originalFetch = window.fetch.bind(window);
            window.fetch = function(input, init) {
                const opts = init || {};
                const timeoutMs = typeof opts._timeoutMs === 'number' ? opts._timeoutMs : 30000; // 30s default
                const retries = typeof opts._retries === 'number' ? opts._retries : (opts && opts.method ? (opts.method.toUpperCase() === 'GET' ? 1 : 0) : 1);
                const noLoading = !!opts._noLoading;

                // Remove custom keys from the request init before sending
                const sanitized = Object.assign({}, opts);
                delete sanitized._timeoutMs; delete sanitized._retries; delete sanitized._noLoading;

                if (!noLoading) window.__loadingOverlay && window.__loadingOverlay.show();

                function doFetch(attempt) {
                    const controller = new AbortController();
                    const timer = setTimeout(() => controller.abort(), timeoutMs);
                    const nextInit = Object.assign({}, sanitized, { signal: controller.signal });
                    return originalFetch(input, nextInit)
                        .then((res) => {
                            clearTimeout(timer);
                            return res;
                        })
                        .catch((err) => {
                            clearTimeout(timer);
                            if (attempt < retries && (err.name === 'AbortError')) {
                                return doFetch(attempt + 1);
                            }
                            throw err;
                        });
                }

                return doFetch(0)
                    .finally(() => {
                        if (!noLoading) window.__loadingOverlay && window.__loadingOverlay.hide();
                    });
            };

            // Helper: safe JSON parse with fallback
            window.parseJsonSafe = async function(response) {
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return { ok: response.ok, status: response.status, raw: text };
                }
            };
        })();

        // Notification System
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notification-container');
                this.notifications = [];
            }

            show(type, title, message = '', duration = 5000) {
                if (!this.container) return;
                
                const notification = this.createElement(type, title, message);
                this.container.appendChild(notification);
                this.notifications.push(notification);

                // Auto remove after duration
                if (duration > 0) {
                    setTimeout(() => {
                        this.remove(notification);
                    }, duration);
                }

                return notification;
            }

            createElement(type, title, message) {
                const div = document.createElement('div');
                div.className = `notification ${type}`;
                
                const icon = this.getIcon(type);
                
                div.innerHTML = `
                    <div class="notification-icon">
                        ${icon}
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        ${message ? `<div>${message}</div>` : ''}
                    </div>
                    <button class="notification-close" onclick="notificationSystem.remove(this.parentElement)">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                `;

                return div;
            }

            getIcon(type) {
                const icons = {
                    info: '<svg viewBox="0 0 24 24"><path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>',
                    warning: '<svg viewBox="0 0 24 24"><path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>',
                    error: '<svg viewBox="0 0 24 24"><path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/></svg>',
                    success: '<svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/></svg>'
                };
                return icons[type] || icons.info;
            }

            remove(notification) {
                if (!notification || !notification.parentElement) return;
                
                notification.classList.add('removing');
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.parentElement.removeChild(notification);
                    }
                    
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }

            clear() {
                this.notifications.forEach(notification => this.remove(notification));
            }
        }

        // Initialize notification system
        const notificationSystem = new NotificationSystem();

        // Helper function for easy use
        function showNotification(type, title, message = '', duration = 5000) {
            return notificationSystem.show(type, title, message, duration);
        }

        // Django messages integration
        function showDjangoMessages(messages) {
            messages.forEach(message => {
                let type = 'info';
                if (message.tags) {
                    if (message.tags.includes('error') || message.tags.includes('danger')) {
                        type = 'error';
                    } else if (message.tags.includes('warning')) {
                        type = 'warning';
                    } else if (message.tags.includes('success')) {
                        type = 'success';
                    }
                }
                showNotification(type, message.message, '', 5000);
            });
        }

        // Process Django messages when page loads
        {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            const djangoMessages = [
                {% for message in messages %}
                {
                    message: "{{ message|escapejs }}",
                    tags: "{{ message.tags|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            showDjangoMessages(djangoMessages);
        });
        {% endif %}

    </script>

</body>

</html>

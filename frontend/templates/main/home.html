{% extends "main/base.html" %}
{% load static %}

{% block extra_css %}
{% endblock %}

{% block title %}User Dashboard{% endblock %}

{% block content %}
      <!-- Content wrapper -->
<div class="content-wrapper">
        <!-- Content -->
    <div class="container-xxl flex-grow-1 container-p-y">
          
  <!-- Hour chart  -->
  <div class="card bg-transparent shadow-none my-6 border-0">
    <div class="card-body row p-0 pb-6 g-6">
      <div class="col-12 col-lg-8 card-separator">
        <h5 class="mb-2">Welcome back,<span class="h4"> {{ current_username }} üëãüèª</span></h5>
        <div class="col-12 col-lg-5">
          <p>Your progress this week is Awesome. let's keep it up and get a lot of points reward !</p>
        </div>
        <div class="d-flex justify-content-between flex-wrap gap-4 me-12">
          <div class="d-flex align-items-center gap-4 me-6 me-sm-0">
            <div class="avatar avatar-lg">
              <div class="avatar-initial bg-label-primary rounded">
                <div class="text-primary">
                  <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="Laptop">
                      <path id="Vector" opacity="0.2" d="M5.9375 26.125V10.6875C5.9375 10.0576 6.18772 9.45352 6.63312 9.00812C7.07852 8.56272 7.68261 8.3125 8.3125 8.3125H29.6875C30.3174 8.3125 30.9215 8.56272 31.3669 9.00812C31.8123 9.45352 32.0625 10.0576 32.0625 10.6875V26.125H5.9375Z" fill="currentColor" />
                      <path
                        id="Vector_2"
                        d="M5.9375 26.125V10.6875C5.9375 10.0576 6.18772 9.45352 6.63312 9.00812C7.07852 8.56272 7.68261 8.3125 8.3125 8.3125H29.6875C30.3174 8.3125 30.9215 8.56272 31.3669 9.00812C31.8123 9.45352 32.0625 10.0576 32.0625 10.6875V26.125M21.375 13.0625H16.625M3.5625 26.125H34.4375V28.5C34.4375 29.1299 34.1873 29.734 33.7419 30.1794C33.2965 30.6248 32.6924 30.875 32.0625 30.875H5.9375C5.30761 30.875 4.70352 30.6248 4.25812 30.1794C3.81272 29.734 3.5625 29.1299 3.5625 28.5V26.125Z"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round" />
                    </g>
                  </svg>
                </div>
              </div>
            </div>
            <div class="content-right">
              <p class="mb-0 fw-medium">Total Projects</p>
              <h4 class="text-primary mb-0">{{ total_projects }}</h4>
            </div>
          </div>
          <div class="d-flex align-items-center gap-4">
            <div class="avatar avatar-lg">
              <div class="avatar-initial bg-label-info rounded">
                <div class="text-info">
                  <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="Lightbulb">
                      <path
                        id="Vector"
                        opacity="0.2"
                        d="M11.6822 24.7891C10.2684 23.6898 9.12342 22.2832 8.33388 20.6759C7.54435 19.0685 7.13099 17.3025 7.12513 15.5117C7.09544 9.06954 12.2759 3.71095 18.7181 3.56251C21.2113 3.50341 23.6599 4.23078 25.7166 5.64147C27.7732 7.05217 29.3335 9.07457 30.1761 11.4219C31.0188 13.7691 31.101 16.3221 30.4112 18.7188C29.7214 21.1154 28.2945 23.2341 26.3329 24.7742C25.8996 25.1092 25.5486 25.5388 25.3068 26.0301C25.065 26.5215 24.9387 27.0617 24.9376 27.6094V28.5C24.9376 28.815 24.8125 29.117 24.5898 29.3397C24.3671 29.5624 24.0651 29.6875 23.7501 29.6875H14.2501C13.9352 29.6875 13.6331 29.5624 13.4104 29.3397C13.1877 29.117 13.0626 28.815 13.0626 28.5V27.6094C13.0589 27.0658 12.9329 26.5301 12.6939 26.0418C12.4549 25.5536 12.1091 25.1255 11.6822 24.7891Z"
                        fill="currentColor" />
                      <path
                        id="Union"
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M25.1509 6.46609C23.2675 5.17419 21.0251 4.50807 18.7418 4.5622L18.7411 4.56221C18.4983 4.56781 18.2574 4.58151 18.0187 4.60305L18.6951 2.56275C21.398 2.49881 24.0526 3.28743 26.2822 4.8168C28.512 6.34629 30.2037 8.53899 31.1173 11.0839C32.031 13.6289 32.1201 16.3969 31.3722 18.9954C30.6243 21.5938 29.0772 23.8909 26.9505 25.5607L26.9445 25.5654L26.9445 25.5654C26.6318 25.8071 26.3785 26.1171 26.204 26.4717C26.0295 26.8263 25.9384 27.2161 25.9376 27.6113V28.5C25.9376 29.0801 25.7072 29.6365 25.2969 30.0468C24.8867 30.457 24.3303 30.6875 23.7501 30.6875H14.2501C13.67 30.6875 13.1136 30.457 12.7033 30.0468C12.2931 29.6365 12.0626 29.0801 12.0626 28.5V27.6131C12.0595 27.2206 11.9683 26.8339 11.7957 26.4815C11.6232 26.1289 11.3737 25.8196 11.0656 25.5764L11.7414 23.5378C11.9208 23.6976 12.1057 23.8517 12.296 23.9996L11.6821 24.7891L12.301 24.0035C12.8459 24.4328 13.2871 24.9792 13.5921 25.6022C13.8971 26.2252 14.0579 26.9089 14.0626 27.6025L14.0627 27.6094L14.0626 28.5C14.0626 28.5497 14.0824 28.5974 14.1175 28.6326C14.1527 28.6677 14.2004 28.6875 14.2501 28.6875H23.7501C23.7999 28.6875 23.8475 28.6677 23.8827 28.6326C23.9179 28.5974 23.9376 28.5497 23.9376 28.5V27.6094L23.9376 27.6074C23.939 26.9073 24.1004 26.2167 24.4096 25.5885C24.7181 24.9616 25.1657 24.4133 25.7181 23.9855C27.5131 22.5752 28.8188 20.6359 29.4502 18.4422C30.082 16.2473 30.0067 13.9093 29.235 11.7597C28.4633 9.61009 27.0344 7.75799 25.1509 6.46609ZM11.7414 23.5378L11.7414 23.5378L18.0187 4.60305L18.018 4.6031L18.6944 2.56276C11.7043 2.72418 6.09331 8.53234 6.12513 15.5156C6.13159 17.458 6.57998 19.3733 7.43632 21.1167C8.29225 22.8593 9.53332 24.3843 11.0656 25.5764L11.7414 23.5378ZM11.7414 23.5378C10.7009 22.6109 9.84781 21.4898 9.23145 20.235C8.50882 18.7638 8.13049 17.1475 8.12512 15.5084L8.12512 15.5071C8.09905 9.84987 12.4637 5.10456 18.018 4.6031L11.7414 23.5378ZM12.0627 34.4375C12.0627 33.8852 12.5104 33.4375 13.0627 33.4375H24.9377C25.49 33.4375 25.9377 33.8852 25.9377 34.4375C25.9377 34.9898 25.49 35.4375 24.9377 35.4375H13.0627C12.5104 35.4375 12.0627 34.9898 12.0627 34.4375ZM20.3697 7.44532C19.8252 7.35302 19.3089 7.71961 19.2166 8.26412C19.1243 8.80864 19.4909 9.32489 20.0354 9.41719C21.2827 9.62862 22.4336 10.222 23.3292 11.1154C24.2249 12.0087 24.8212 13.1581 25.0358 14.4048C25.1295 14.9491 25.6467 15.3144 26.191 15.2207C26.7353 15.127 27.1005 14.6098 27.0068 14.0655C26.722 12.4107 25.9305 10.8851 24.7417 9.69934C23.5528 8.51353 22.0252 7.72596 20.3697 7.44532Z"
                        fill="currentColor" />
                    </g>
                  </svg>
                </div>
              </div>
            </div>
            <div class="content-right">
              <p class="mb-0 fw-medium">Test Success Rate</p>
              <h4 class="text-info mb-0">{{ test_success_rate }}%</h4>
            </div>
          </div>
          <div class="d-flex align-items-center gap-4">
            <div class="avatar avatar-lg">
              <div class="avatar-initial bg-label-warning rounded">
                <div class="text-warning">
                  <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="Check">
                      <path
                        id="Vector"
                        opacity="0.2"
                        d="M8.08984 29.9102C6.72422 28.5445 7.62969 25.6797 6.93203 24.0023C6.23438 22.325 3.5625 20.8555 3.5625 19C3.5625 17.1445 6.20469 15.7344 6.93203 13.9977C7.65938 12.2609 6.72422 9.45547 8.08984 8.08984C9.45547 6.72422 12.3203 7.62969 13.9977 6.93203C15.675 6.23438 17.1445 3.5625 19 3.5625C20.8555 3.5625 22.2656 6.20469 24.0023 6.93203C25.7391 7.65938 28.5445 6.72422 29.9102 8.08984C31.2758 9.45547 30.3703 12.3203 31.068 13.9977C31.7656 15.675 34.4375 17.1445 34.4375 19C34.4375 20.8555 31.7953 22.2656 31.068 24.0023C30.3406 25.7391 31.2758 28.5445 29.9102 29.9102C28.5445 31.2758 25.6797 30.3703 24.0023 31.068C22.325 31.7656 20.8555 34.4375 19 34.4375C17.1445 34.4375 15.7344 31.7953 13.9977 31.068C12.2609 30.3406 9.45547 31.2758 8.08984 29.9102Z"
                        fill="currentColor" />
                      <path
                        id="Vector_2"
                        d="M25.5312 15.4375L16.818 23.75L12.4687 19.5937M8.08984 29.9102C6.72422 28.5445 7.62969 25.6797 6.93203 24.0023C6.23437 22.325 3.5625 20.8555 3.5625 19C3.5625 17.1445 6.20469 15.7344 6.93203 13.9977C7.65937 12.2609 6.72422 9.45547 8.08984 8.08984C9.45547 6.72422 12.3203 7.62969 13.9977 6.93203C15.675 6.23437 17.1445 3.5625 19 3.5625C20.8555 3.5625 22.2656 6.20469 24.0023 6.93203C25.7391 7.65937 28.5445 6.72422 29.9102 8.08984C31.2758 9.45547 30.3703 12.3203 31.068 13.9977C31.7656 15.675 34.4375 17.1445 34.4375 19C34.4375 20.8555 31.7953 22.2656 31.068 24.0023C30.3406 25.7391 31.2758 28.5445 29.9102 29.9102C28.5445 31.2758 25.6797 30.3703 24.0023 31.068C22.325 31.7656 20.8555 34.4375 19 34.4375C17.1445 34.4375 15.7344 31.7953 13.9977 31.068C12.2609 30.3406 9.45547 31.2758 8.08984 29.9102Z"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round" />
                    </g>
                  </svg>
                </div>
              </div>
            </div>
            <div class="content-right">
              <p class="mb-0 fw-medium">Test Cases</p>
              <h4 class="text-warning mb-0">{{ total_test_cases }}</h4>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4 ps-md-4 ps-lg-6">
        <div class="d-flex justify-content-between align-items-center">
            <div>
              <div>
                <h5 class="mb-1">This Week</h5>
                <p class="mb-9">Weekly statistics</p>
              </div>
              <div class="time-spending-chart">
                <h4 class="mb-2">{{ projects_this_week }}<span class="text-body"> Projects</span></h4>
                {% if projects_change > 0 %}
                <span class="badge bg-label-success">+{{ projects_change }}%</span>
                {% elif projects_change < 0 %}
                <span class="badge bg-label-danger">{{ projects_change }}%</span>
                {% else %}
                <span class="badge bg-label-secondary">0%</span>
                {% endif %}
              </div>
            </div>
          <div id="leadsReportChart"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Hour chart End  -->

  <!-- Request Frequency Dashboard -->
  <div class="row mb-6 g-6">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div>
            <h5 class="card-title m-0 me-2">Request Frequency Dashboard</h5>
            <p class="text-body-secondary mb-0">T·∫ßn su·∫•t ho·∫°t ƒë·ªông trong 30 ng√†y qua</p>
          </div>
          <div class="dropdown">
            <button class="btn text-body-secondary p-0" type="button" id="requestFrequency" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="icon-base bx bx-dots-vertical-rounded icon-lg"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="requestFrequency">
              <a class="dropdown-item" href="javascript:void(0);">Last 30 Days</a>
              <a class="dropdown-item" href="javascript:void(0);">Last 7 Days</a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
              <div class="d-flex align-items-center">
                <div class="avatar me-3">
                  <div class="avatar-initial rounded bg-label-primary">
                    <i class="icon-base bx bx-bar-chart-alt-2 icon-lg"></i>
                  </div>
                </div>
                <div>
                  <p class="mb-0 text-body-secondary">Total Activities</p>
                  <h4 class="mb-0">{{ total_activities_30_days }}</h4>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
              <div class="d-flex align-items-center">
                <div class="avatar me-3">
                  <div class="avatar-initial rounded bg-label-success">
                    <i class="icon-base bx bx-trending-up icon-lg"></i>
                  </div>
                </div>
                <div>
                  <p class="mb-0 text-body-secondary">Avg Daily</p>
                  <h4 class="mb-0">{{ avg_daily_activities }}</h4>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
              <div class="d-flex align-items-center">
                <div class="avatar me-3">
                  <div class="avatar-initial rounded bg-label-info">
                    <i class="icon-base bx bx-line-chart icon-lg"></i>
                  </div>
                </div>
                <div>
                  <p class="mb-0 text-body-secondary">Peak Day</p>
                  <h4 class="mb-0">{{ max_daily_activities }}</h4>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-6">
              <div class="d-flex align-items-center">
                <div class="avatar me-3">
                  <div class="avatar-initial rounded bg-label-warning">
                    <i class="icon-base bx bx-calendar-week icon-lg"></i>
                  </div>
                </div>
                <div>
                  <p class="mb-0 text-body-secondary">Last 7 Days</p>
                  <h4 class="mb-0">{{ last_7_days_activities }}</h4>
                </div>
              </div>
            </div>
          </div>
          <!-- <div class="alert alert-info mb-0">
            <small><i class="icon-base bx bx-info-circle"></i> <strong>L∆∞u √Ω:</strong> D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c. N·∫øu v·ª´a t·∫°o project/upload document/execute test, vui l√≤ng <a href="javascript:location.reload();" class="alert-link">refresh trang</a> ƒë·ªÉ xem d·ªØ li·ªáu m·ªõi nh·∫•t.</small>
          </div> -->
          {% if total_activities_30_days > 0 %}
            <div id="requestFrequencyChart" style="min-height: 350px;"></div>
          {% else %}
            <div class="d-flex align-items-center justify-content-center" style="min-height: 350px;">
              <div class="text-center">
                <i class="icon-base bx bx-bar-chart-alt-2 icon-5x text-body-secondary mb-3"></i>
                <h5 class="text-body-secondary">No Data Available</h5>
                <p class="text-body-secondary mb-0">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o trong 30 ng√†y qua</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Request Frequency Dashboard End -->

  <!-- Recent Projects and All Test Reports -->
  <div class="row mb-6 g-6">
    <div class="col-12 col-xl-4 col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="card-title mb-0">
            <h5 class="m-0 me-2">Recent Projects</h5>
          </div>
          <div class="dropdown">
            <button class="btn text-body-secondary p-0" type="button" id="recentProjects" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="icon-base bx bx-dots-vertical-rounded icon-lg"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="recentProjects">
              <a class="dropdown-item" href="{% url 'project_list' %}">View All</a>
              <a class="dropdown-item" href="{% url 'project_add' %}">New Project</a>
            </div>
          </div>
        </div>
        <div class="px-5 py-4 border border-start-0 border-end-0">
          <div class="d-flex justify-content-between align-items-center">
            <p class="mb-0 text-uppercase">Project Name</p>
            <p class="mb-0 text-uppercase">Date</p>
          </div>
        </div>
        <div class="card-body">
          {% if recent_projects_page %}
            {% for project in recent_projects_page %}
            <div class="d-flex justify-content-between align-items-center {% if not forloop.last %}mb-6{% endif %}">
              <div class="d-flex align-items-center">
                <div class="avatar me-4 w-px-34 h-px-34">
                  <span class="avatar-initial rounded bg-label-primary">
                    <i class="icon-base bx bx-folder icon-lg"></i>
                  </span>
                </div>
                <div>
                  <div>
                    <h6 class="mb-0 text-truncate">
                      <a href="{% url 'project_detail_by_uuid' project_uuid=project.uuid %}" class="text-body">
                        {{ project.project_name|truncatechars:25 }}
                      </a>
                    </h6>
                    <small class="text-truncate text-body">{{ project.created_at|date:"M d, Y" }}</small>
                  </div>
                </div>
              </div>
              <div class="text-end">
                <span class="badge bg-label-info">{{ project.documents.count }}</span>
              </div>
            </div>
            {% endfor %}
            {% if recent_projects_page.has_other_pages %}
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
              <span class="text-body-secondary small">
                Page {{ recent_projects_page.number }} of {{ recent_projects_page.paginator.num_pages }}
              </span>
              <div class="d-flex gap-2">
                {% if recent_projects_page.has_previous %}
                <a href="?projects_page={{ recent_projects_page.previous_page_number }}{% if request.GET.reports_page %}&reports_page={{ request.GET.reports_page }}{% endif %}{% if request.GET.documents_page %}&documents_page={{ request.GET.documents_page }}{% endif %}" 
                   class="btn btn-sm btn-outline-secondary">
                  <i class="icon-base bx bx-chevron-left"></i> Previous
                </a>
                {% endif %}
                {% if recent_projects_page.has_next %}
                <a href="?projects_page={{ recent_projects_page.next_page_number }}{% if request.GET.reports_page %}&reports_page={{ request.GET.reports_page }}{% endif %}{% if request.GET.documents_page %}&documents_page={{ request.GET.documents_page }}{% endif %}" 
                   class="btn btn-sm btn-outline-primary">
                  Next <i class="icon-base bx bx-chevron-right"></i>
                </a>
                {% endif %}
              </div>
            </div>
            {% endif %}
          {% else %}
            <div class="text-center py-4">
              <p class="text-body-secondary mb-0">No projects yet</p>
              <a href="{% url 'project_add' %}" class="btn btn-sm btn-primary mt-2">Create Project</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-8 col-md-6">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="card-title m-0 me-2">All Test Reports</h5>
          <div class="dropdown">
            <button class="btn text-body-secondary p-0" type="button" id="allReports" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="icon-base bx bx-dots-vertical-rounded icon-lg"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="allReports">
              <a class="dropdown-item" href="{% url 'reports' %}">View All Reports</a>
              <a class="dropdown-item" href="javascript:void(0);">Refresh</a>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if all_reports_page|length > 0 %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Project</th>
                    <th>Test Suite</th>
                    <th>Executed At</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for report in all_reports_page %}
                  <tr>
                    <td>
                      <a href="{% url 'project_detail_by_uuid' project_uuid=report.project.uuid %}" class="text-body">
                        {{ report.project.project_name|truncatechars:30 }}
                      </a>
                    </td>
                    <td>
                      {% if report.test_suite %}
                        {{ report.test_suite.test_suite_name|truncatechars:25 }}
                      {% else %}
                        <span class="text-body-secondary">N/A</span>
                      {% endif %}
                    </td>
                    <td>{{ report.executed_at|date:"M d, Y H:i" }}</td>
                    <td>
                      <a href="{% url 'project_detail_by_uuid' project_uuid=report.project.uuid %}" class="btn btn-sm btn-outline-primary">
                        View
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if all_reports_page.has_other_pages %}
            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
              <span class="text-body-secondary small">
                Page {{ all_reports_page.number }} of {{ all_reports_page.paginator.num_pages }}
              </span>
              <div class="d-flex gap-2">
                {% if all_reports_page.has_previous %}
                <a href="?reports_page={{ all_reports_page.previous_page_number }}{% if request.GET.projects_page %}&projects_page={{ request.GET.projects_page }}{% endif %}{% if request.GET.documents_page %}&documents_page={{ request.GET.documents_page }}{% endif %}" 
                   class="btn btn-sm btn-outline-secondary">
                  <i class="icon-base bx bx-chevron-left"></i> Previous
                </a>
                {% endif %}
                {% if all_reports_page.has_next %}
                <a href="?reports_page={{ all_reports_page.next_page_number }}{% if request.GET.projects_page %}&projects_page={{ request.GET.projects_page }}{% endif %}{% if request.GET.documents_page %}&documents_page={{ request.GET.documents_page }}{% endif %}" 
                   class="btn btn-sm btn-outline-primary">
                  Next <i class="icon-base bx bx-chevron-right"></i>
                </a>
                {% endif %}
              </div>
            </div>
            {% endif %}
          {% else %}
            <div class="text-center py-4">
              <p class="text-body-secondary mb-0">No test reports yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!--  Topic and Instructors  End-->

  <!-- Recent Documents -->
  <div class="row mb-6 g-6">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="card-title mb-0">
            <h5 class="m-0 me-2">Recent Documents</h5>
          </div>
          <div class="dropdown">
            <button class="btn text-body-secondary p-0" type="button" id="recentDocuments" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="icon-base bx bx-dots-vertical-rounded icon-lg"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="recentDocuments">
              <a class="dropdown-item" href="{% url 'library' %}">View All Documents</a>
            </div>
          </div>
        </div>
        <div class="px-5 py-4 border border-start-0 border-end-0">
          <div class="d-flex justify-content-between align-items-center">
            <p class="mb-0 text-uppercase">Document Name</p>
            <p class="mb-0 text-uppercase">Date</p>
          </div>
        </div>
        <div class="card-body">
          {% if recent_documents_page %}
            {% for document in recent_documents_page %}
            <div class="d-flex justify-content-between align-items-center {% if not forloop.last %}mb-6{% endif %}">
              <div class="d-flex align-items-center">
                <div class="avatar me-4 w-px-34 h-px-34">
                  <span class="avatar-initial rounded bg-label-success">
                    <i class="icon-base bx bx-file icon-lg"></i>
                  </span>
                </div>
                <div>
                  <div>
                    <h6 class="mb-0 text-truncate">
                      <a href="{% url 'project_detail_by_uuid' project_uuid=document.project.uuid %}" class="text-body">
                        {{ document.original_filename|default:document.file.name|default:document.link|truncatechars:25 }}
                      </a>
                    </h6>
                    <small class="text-truncate text-body">
                      <a href="{% url 'project_detail_by_uuid' project_uuid=document.project.uuid %}" class="text-body-secondary">
                        {{ document.project.project_name|truncatechars:20 }}
                      </a>
                    </small>
                  </div>
                </div>
              </div>
              <div class="text-end">
                <small class="text-body-secondary">{{ document.uploaded_at|date:"M d, Y" }}</small>
                <div>
                  {% if document.ai_processing_status == 'completed' %}
                  <span class="badge bg-label-success">Completed</span>
                  {% elif document.ai_processing_status == 'processing' %}
                  <span class="badge bg-label-info">Processing</span>
                  {% elif document.ai_processing_status == 'failed' %}
                  <span class="badge bg-label-danger">Failed</span>
                  {% else %}
                  <span class="badge bg-label-secondary">Pending</span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
            {% if recent_documents_page.has_other_pages %}
            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
              <span class="text-body-secondary small">
                Page {{ recent_documents_page.number }} of {{ recent_documents_page.paginator.num_pages }}
              </span>
              <div class="d-flex gap-2">
                {% if recent_documents_page.has_previous %}
                <a href="?documents_page={{ recent_documents_page.previous_page_number }}{% if request.GET.projects_page %}&projects_page={{ request.GET.projects_page }}{% endif %}{% if request.GET.reports_page %}&reports_page={{ request.GET.reports_page }}{% endif %}" 
                   class="btn btn-sm btn-outline-secondary">
                  <i class="icon-base bx bx-chevron-left"></i> Previous
                </a>
                {% endif %}
                {% if recent_documents_page.has_next %}
                <a href="?documents_page={{ recent_documents_page.next_page_number }}{% if request.GET.projects_page %}&projects_page={{ request.GET.projects_page }}{% endif %}{% if request.GET.reports_page %}&reports_page={{ request.GET.reports_page }}{% endif %}" 
                   class="btn btn-sm btn-outline-primary">
                  Next <i class="icon-base bx bx-chevron-right"></i>
                </a>
                {% endif %}
              </div>
            </div>
            {% endif %}
          {% else %}
            <div class="text-center py-4">
              <p class="text-body-secondary mb-0">No documents yet</p>
              <a href="{% url 'project_list' %}" class="btn btn-sm btn-primary mt-2">Upload Document</a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Recent Documents End -->



</div>

{{ request_frequency_data|json_script:"request-frequency-data" }}
<script>
function initRequestFrequencyChart() {
  // Check if ApexCharts is loaded
  if (typeof ApexCharts === 'undefined') {
    console.error('ApexCharts is not loaded');
    return;
  }
  
  // Get data from JSON script tag (using Django's json_script)
  const dataScript = document.getElementById('request-frequency-data');
  if (!dataScript || !dataScript.textContent) {
    console.error('Request frequency data not found');
    return;
  }
  
  try {
    const frequencyData = JSON.parse(dataScript.textContent);
    
    console.log('Request Frequency Data:', frequencyData);
    console.log('Data Length:', frequencyData ? frequencyData.length : 0);
    
    if (!frequencyData || frequencyData.length === 0) {
      console.warn('No frequency data available');
      return;
    }
    
    // Extract data for chart - only Total Activities (like the example image)
    const dates = frequencyData.map(item => item.date_display);
    const totals = frequencyData.map(item => item.total);
    
    console.log('Dates:', dates);
    console.log('Totals:', totals);
    console.log('Total Activities 30 Days:', {{ total_activities_30_days }});
    
    const options = {
      series: [
        {
          name: 'Total Activities',
          data: totals
        }
      ],
      chart: {
        height: 350,
        type: 'line',
        toolbar: {
          show: true,
          tools: {
            download: true,
            selection: true,
            zoom: true,
            zoomin: true,
            zoomout: true,
            pan: true,
            reset: true
          }
        },
        fontFamily: 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif',
        zoom: {
          enabled: true
        }
      },
      stroke: {
        width: 2,
        curve: 'smooth'
      },
      colors: ['#6366f1'],
      dataLabels: {
        enabled: false
      },
      markers: {
        size: 4,
        hover: {
          size: 6
        }
      },
      xaxis: {
        categories: dates,
        labels: {
          rotate: -45,
          rotateAlways: false,
          style: {
            fontSize: '12px'
          }
        },
        title: {
          text: 'Date'
        }
      },
      yaxis: {
        title: {
          text: 'Number of Activities'
        },
        min: 0
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val + ' activities'
          }
        }
      },
      legend: {
        show: true,
        position: 'top',
        horizontalAlign: 'right'
      },
      grid: {
        strokeDashArray: 3,
        borderColor: '#e0e0e0'
      }
    };
    
    // Render chart
    const chartEl = document.querySelector('#requestFrequencyChart');
    if (chartEl) {
      if (chartEl._apexchart) {
        chartEl._apexchart.destroy();
      }
      const chart = new ApexCharts(chartEl, options);
      chartEl._apexchart = chart;
      chart.render();
    } else {
      console.error('Chart element not found');
    }
  } catch (error) {
    console.error('Error initializing request frequency chart:', error);
  }
}

// Load ApexCharts and initialize chart
document.addEventListener('DOMContentLoaded', function () {
  // Check if ApexCharts is already loaded
  if (typeof ApexCharts !== 'undefined') {
    initRequestFrequencyChart();
  } else {
    // Load ApexCharts dynamically
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/apexcharts';
    script.onload = function() {
      initRequestFrequencyChart();
    };
    script.onerror = function() {
      console.error('Failed to load ApexCharts library');
    };
    document.head.appendChild(script);
  }
});
</script>

{% endblock %}
